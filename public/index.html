<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Todo</title>
    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"] {
            flex: 1;
            background-color: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 5px #00ff00;
        }

        button {
            background-color: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background-color: #00ff00;
            color: #000;
        }

        .todo-list {
            border: 1px solid #00ff00;
            padding: 20px;
            background-color: #111;
        }


        .todo-item:last-child {
            border-bottom: none;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            border: 1px solid #00ff00;
            background-color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff00;
        }

        .todo-checkbox.checked {
            background-color: #00ff00;
            color: #000;
        }

        .todo-text {
            flex: 1;
            font-size: 14px;
        }

        .todo-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .delete-btn {
            background-color: #111;
            color: #ff0000;
            border: 1px solid #ff0000;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background-color: #ff0000;
            color: #000;
        }

        .edit-btn {
            background-color: #111;
            color: #ffff00;
            border: 1px solid #ffff00;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background-color: #ffff00;
            color: #000;
        }

        .todo-timestamps {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            cursor: move;
            transition: all 0.2s ease;
        }

        .todo-item:hover {
            background-color: #111;
            border-radius: 4px;
            margin: 0 -10px;
            padding: 10px;
        }

        .todo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .todo-item.drag-over {
            border-top: 2px solid #00ff00;
            margin-top: 2px;
        }

        .drag-handle {
            color: #666;
            font-size: 12px;
            cursor: move;
            user-select: none;
            padding: 2px 5px;
            margin-right: 5px;
        }

        .drag-handle:hover {
            color: #00ff00;
        }

        .todo-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .todo-actions {
            display: flex;
            gap: 5px;
        }

        .edit-input {
            width: 100%;
            background-color: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .edit-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 5px #00ff00;
        }

        .save-btn {
            background-color: #111;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 5px;
        }

        .save-btn:hover {
            background-color: #00ff00;
            color: #000;
        }

        .cancel-btn {
            background-color: #111;
            color: #888;
            border: 1px solid #888;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background-color: #888;
            color: #000;
        }

        .notes-section {
            margin-top: 10px;
            padding: 8px;
            background-color: #0a0a0a;
            border: 1px solid #333;
            border-radius: 3px;
        }

        .notes-text {
            font-size: 11px;
            color: #aaa;
            line-height: 1.3;
        }

        .notes-text strong {
            color: #00ff00;
            font-weight: bold;
        }

        .notes-text em {
            color: #ffff00;
            font-style: italic;
        }

        .notes-text u {
            text-decoration: underline;
        }

        .notes-text h1, .notes-text h2, .notes-text h3 {
            color: #00ff88;
            margin: 5px 0;
        }

        .notes-text ul, .notes-text ol {
            margin-left: 20px;
            color: #aaa;
        }

        .notes-text li {
            margin: 2px 0;
        }

        .notes-text blockquote {
            border-left: 2px solid #00ff00;
            padding-left: 10px;
            margin: 5px 0;
            color: #888;
            font-style: italic;
        }

        .notes-text p {
            margin: 3px 0;
        }

        .notes-input {
            width: 100%;
            background-color: #111;
            color: #00ff00;
            border: 1px solid #333;
            padding: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            min-height: 40px;
            resize: vertical;
        }

        .notes-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 3px #00ff00;
        }

        /* Quill Editor Terminal Theme */
        .ql-toolbar {
            background-color: #111 !important;
            border: 1px solid #333 !important;
            border-bottom: none !important;
        }

        .ql-toolbar .ql-picker-label {
            color: #00ff00 !important;
        }

        .ql-toolbar .ql-stroke {
            stroke: #00ff00 !important;
        }

        .ql-toolbar .ql-fill {
            fill: #00ff00 !important;
        }

        .ql-toolbar button:hover {
            background-color: #333 !important;
        }

        .ql-container {
            background-color: #111 !important;
            border: 1px solid #333 !important;
            color: #00ff00 !important;
            font-family: 'Courier New', monospace !important;
            font-size: 11px !important;
        }

        .ql-editor {
            color: #00ff00 !important;
            min-height: 60px !important;
        }

        .ql-editor.ql-blank::before {
            color: #666 !important;
            font-style: italic;
        }

        .ql-picker-options {
            background-color: #111 !important;
            border: 1px solid #333 !important;
        }

        .ql-picker-item {
            color: #00ff00 !important;
        }

        .ql-picker-item:hover {
            background-color: #333 !important;
        }

        .notes-editor-container {
            margin: 5px 0;
        }

        .notes-btn {
            background-color: #111;
            color: #00aa00;
            border: 1px solid #00aa00;
            padding: 3px 8px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 5px;
        }

        .notes-btn:hover {
            background-color: #00aa00;
            color: #000;
        }

        .export-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .export-btn {
            background-color: #111;
            color: #00aaff;
            border: 1px solid #00aaff;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
        }

        .export-btn:hover {
            background-color: #00aaff;
            color: #000;
        }

        .project-header {
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #333;
            padding: 20px;
            background-color: #111;
        }

        .project-title {
            font-size: 28px;
            color: #00ff00;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .project-description {
            font-size: 14px;
            color: #aaa;
            font-style: italic;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .project-edit-btn {
            background-color: #111;
            color: #888;
            border: 1px solid #888;
            padding: 5px 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .project-edit-btn:hover {
            background-color: #888;
            color: #000;
        }

        .project-edit-form {
            display: none;
            text-align: left;
            margin-top: 15px;
        }

        .project-input {
            width: 100%;
            background-color: #000;
            color: #00ff00;
            border: 1px solid #333;
            padding: 8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .project-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 5px #00ff00;
        }

        .project-textarea {
            width: 100%;
            background-color: #000;
            color: #00ff00;
            border: 1px solid #333;
            padding: 8px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            min-height: 60px;
            resize: vertical;
        }

        .project-textarea:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 5px #00ff00;
        }

        .project-buttons {
            margin-top: 10px;
        }

        .prompt {
            color: #00ff00;
            margin-bottom: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .time-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="time-display" id="timeDisplay"></div>
    <div class="container">
        <div class="project-header" id="projectHeader">
            <div class="project-title" id="projectTitle">Todo Project</div>
            <div class="project-description" id="projectDescription">Click edit to add a project description</div>
            <button class="project-edit-btn" onclick="editProject()">EDIT PROJECT</button>
            
            <div class="project-edit-form" id="projectEditForm">
                <input type="text" id="projectTitleInput" class="project-input" placeholder="Project Title">
                <textarea id="projectDescriptionInput" class="project-textarea" placeholder="Project Description"></textarea>
                <div class="project-buttons">
                    <button class="notes-btn" onclick="saveProject()">SAVE</button>
                    <button class="cancel-btn" onclick="cancelProjectEdit()">CANCEL</button>
                </div>
            </div>
        </div>
        
        <div class="export-section">
            <button class="export-btn" onclick="exportToPDF()">📄 EXPORT TO PDF</button>
        </div>
        
        <div class="input-section">
            <div class="prompt">$ add-todo:</div>
            <div class="input-container">
                <input type="text" id="todoInput" placeholder="Enter new todo..." />
                <button onclick="addTodo()">ADD</button>
            </div>
        </div>

        <div class="todo-list" id="todoList">
            <div class="empty-state">No todos yet. Add one above!</div>
        </div>
    </div>

    <script>
        let todos = [];
        let projectInfo = { title: 'Todo Project', description: '' };

        async function loadProject() {
            try {
                const response = await fetch('/api/project');
                if (response.ok) {
                    projectInfo = await response.json();
                } else {
                    // Use defaults if API fails
                    projectInfo = { title: 'Todo Project', description: '' };
                }
                updateProjectDisplay();
            } catch (error) {
                console.error('Error loading project:', error);
                // Use defaults on error
                projectInfo = { title: 'Todo Project', description: '' };
                updateProjectDisplay();
            }
        }

        function updateProjectDisplay() {
            document.getElementById('projectTitle').textContent = projectInfo.title || 'Todo Project';
            document.getElementById('projectDescription').textContent = projectInfo.description || 'Click edit to add a project description';
        }

        function editProject() {
            document.getElementById('projectTitleInput').value = projectInfo.title || '';
            document.getElementById('projectDescriptionInput').value = projectInfo.description || '';
            document.getElementById('projectEditForm').style.display = 'block';
            document.querySelector('.project-edit-btn').style.display = 'none';
        }

        async function saveProject() {
            const title = document.getElementById('projectTitleInput').value.trim();
            const description = document.getElementById('projectDescriptionInput').value.trim();
            
            try {
                const response = await fetch('/api/project', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, description }),
                });

                if (response.ok) {
                    projectInfo.title = title || 'Todo Project';
                    projectInfo.description = description;
                    updateProjectDisplay();
                    cancelProjectEdit();
                }
            } catch (error) {
                console.error('Error saving project:', error);
            }
        }

        function cancelProjectEdit() {
            document.getElementById('projectEditForm').style.display = 'none';
            document.querySelector('.project-edit-btn').style.display = 'inline-block';
        }

        async function loadTodos() {
            try {
                const response = await fetch('/api/todos');
                todos = await response.json();
                renderTodos();
            } catch (error) {
                console.error('Error loading todos:', error);
            }
        }

        async function addTodo() {
            const input = document.getElementById('todoInput');
            const text = input.value.trim();
            
            if (!text) return;

            try {
                const response = await fetch('/api/todos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text }),
                });

                if (response.ok) {
                    input.value = '';
                    loadTodos();
                }
            } catch (error) {
                console.error('Error adding todo:', error);
            }
        }

        async function toggleTodo(id, completed) {
            try {
                const response = await fetch(`/api/todos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ completed }),
                });

                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Error updating todo:', error);
            }
        }

        async function editTodo(id, newText, newNotes) {
            try {
                const updateData = {};
                if (newText !== undefined) updateData.text = newText;
                if (newNotes !== undefined) updateData.notes = newNotes;
                
                console.log('Updating todo', id, 'with data:', updateData);
                
                const response = await fetch(`/api/todos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData),
                });

                if (response.ok) {
                    console.log('Update successful');
                    // Update local todos array immediately
                    const todoIndex = todos.findIndex(t => t.id === id);
                    if (todoIndex !== -1) {
                        if (newText !== undefined) todos[todoIndex].text = newText;
                        if (newNotes !== undefined) todos[todoIndex].notes = newNotes;
                        todos[todoIndex].updated_at = new Date().toISOString();
                    }
                    renderTodos();
                    // Also refresh from server to get accurate timestamp
                    setTimeout(loadTodos, 100);
                } else {
                    console.error('Update failed:', await response.text());
                    loadTodos(); // Reload on error
                }
            } catch (error) {
                console.error('Error editing todo:', error);
                loadTodos(); // Reload on error
            }
        }

        function toggleNotes(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
            const notesSection = todoElement.querySelector('.notes-section');
            
            if (notesSection.style.display === 'none' || !notesSection.style.display) {
                notesSection.style.display = 'block';
            } else {
                notesSection.style.display = 'none';
            }
        }

        let currentEditor = null;
        let currentEditingId = null;
        let originalNotesContent = null;
        let autoSaveTimeout = null;

        function editNotes(id) {
            // If another editor is open, auto-save it first
            if (currentEditor && currentEditingId && currentEditingId !== id) {
                autoSaveCurrentEditor();
            }

            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
            const notesText = todoElement.querySelector('.notes-text');
            const notesButtons = todoElement.querySelector('.notes-buttons');
            
            // Store original content for comparison
            originalNotesContent = todo.notes || '';
            
            // Create editor container
            const editorContainer = document.createElement('div');
            editorContainer.className = 'notes-editor-container';
            editorContainer.id = `editor-${id}`;
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'notes-btn';
            saveBtn.textContent = 'SAVE & CLOSE';
            saveBtn.onclick = () => saveNotesFromEditor(id);
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'notes-btn';
            cancelBtn.textContent = 'DISCARD';
            cancelBtn.onclick = () => cancelNotesEdit(id);
            
            notesText.style.display = 'none';
            notesButtons.style.display = 'none';
            
            notesText.parentNode.insertBefore(editorContainer, notesText);
            notesText.parentNode.insertBefore(saveBtn, notesText);
            notesText.parentNode.insertBefore(cancelBtn, notesText);
            
            // Initialize Quill editor
            currentEditor = new Quill(`#editor-${id}`, {
                theme: 'snow',
                placeholder: 'Add notes with formatting...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'header': [1, 2, 3, false] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote'],
                        ['clean']
                    ]
                }
            });
            
            // Set existing content
            if (todo.notes) {
                currentEditor.root.innerHTML = todo.notes;
            }
            
            currentEditingId = id;
            
            // Set up auto-save on content change
            currentEditor.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        autoSaveCurrentEditor(false); // false = don't close editor
                    }, 2000); // Auto-save after 2 seconds of inactivity
                }
            });
            
            currentEditor.focus();
        }

        function autoSaveCurrentEditor(closeEditor = true) {
            if (currentEditor && currentEditingId) {
                const htmlContent = currentEditor.root.innerHTML;
                const plainText = currentEditor.getText().trim();
                
                // Only save if content has changed and is not empty
                if (htmlContent !== originalNotesContent && plainText.length > 0) {
                    console.log('Auto-saving notes for todo', currentEditingId);
                    saveNotes(currentEditingId, htmlContent);
                }
                
                if (closeEditor) {
                    currentEditor = null;
                    currentEditingId = null;
                    originalNotesContent = null;
                    clearTimeout(autoSaveTimeout);
                }
            }
        }

        function saveNotesFromEditor(id) {
            if (currentEditor && currentEditingId === id) {
                clearTimeout(autoSaveTimeout);
                const htmlContent = currentEditor.root.innerHTML;
                const plainText = currentEditor.getText().trim();
                
                // Always save when explicitly requested, even if empty (to clear notes)
                console.log('Manually saving HTML notes for todo', id, ':', htmlContent);
                saveNotes(id, plainText.length > 0 ? htmlContent : '');
                
                currentEditor = null;
                currentEditingId = null;
                originalNotesContent = null;
            }
        }

        function saveNotes(id, notes) {
            console.log('Saving notes for todo', id, ':', notes);
            editTodo(id, undefined, notes);
        }

        function cancelNotesEdit(id) {
            if (currentEditor && currentEditingId === id) {
                clearTimeout(autoSaveTimeout);
                currentEditor = null;
                currentEditingId = null;
                originalNotesContent = null;
            }
            renderTodos();
        }

        // Auto-save when user clicks elsewhere or switches todos
        document.addEventListener('click', function(e) {
            if (currentEditor && currentEditingId) {
                const isClickInsideEditor = e.target.closest(`#editor-${currentEditingId}`) || 
                                          e.target.closest('.ql-toolbar') ||
                                          e.target.closest('.notes-btn');
                
                // Only auto-save and close if clicking completely outside the editor area
                if (!isClickInsideEditor) {
                    // Small delay to allow for button clicks
                    setTimeout(() => {
                        if (currentEditor && currentEditingId) {
                            autoSaveCurrentEditor(true);
                            renderTodos();
                        }
                    }, 100);
                }
            }
        });

        // Auto-save when user tries to leave the page
        window.addEventListener('beforeunload', function(e) {
            if (currentEditor && currentEditingId) {
                autoSaveCurrentEditor(false);
            }
        });

        function exportToPDF() {
            window.open('/api/todos/export/pdf', '_blank');
        }

        function startEdit(id) {
            const todo = todos.find(t => t.id === id);
            if (!todo) return;

            const todoElement = document.querySelector(`[data-todo-id="${id}"]`);
            const textElement = todoElement.querySelector('.todo-text');
            const actionsElement = todoElement.querySelector('.todo-actions');

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = todo.text;

            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-btn';
            saveBtn.textContent = 'SAVE';
            saveBtn.onclick = () => saveEdit(id, input.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-btn';
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.onclick = () => cancelEdit(id);

            textElement.style.display = 'none';
            textElement.parentNode.insertBefore(input, textElement);
            
            actionsElement.innerHTML = '';
            actionsElement.appendChild(saveBtn);
            actionsElement.appendChild(cancelBtn);

            input.focus();
            input.select();

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveEdit(id, input.value);
                } else if (e.key === 'Escape') {
                    cancelEdit(id);
                }
            });
        }

        function saveEdit(id, newText) {
            if (newText.trim()) {
                editTodo(id, newText.trim(), undefined);
            } else {
                cancelEdit(id);
            }
        }

        function cancelEdit(id) {
            renderTodos();
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function deleteTodo(id) {
            try {
                const response = await fetch(`/api/todos/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }

        async function reorderTodos(todoIds) {
            try {
                console.log('Reordering todos:', todoIds);
                const response = await fetch('/api/todos/reorder', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ todoIds }),
                });

                if (!response.ok) {
                    console.error('Error reordering todos - response not ok:', await response.text());
                    loadTodos(); // Reload on error
                } else {
                    console.log('Reorder successful');
                }
            } catch (error) {
                console.error('Error reordering todos:', error);
                loadTodos(); // Reload on error
            }
        }

        let draggedElement = null;
        let draggedId = null;

        function handleDragStart(e) {
            draggedElement = e.target.closest('.todo-item');
            draggedId = parseInt(draggedElement.dataset.todoId);
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
                draggedId = null;
            }
            
            // Remove drag-over class from all items
            document.querySelectorAll('.todo-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const targetItem = e.target.closest('.todo-item');
            if (targetItem && targetItem !== draggedElement) {
                targetItem.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const targetItem = e.target.closest('.todo-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetItem = e.target.closest('.todo-item');
            
            if (targetItem && draggedId && targetItem !== draggedElement) {
                const targetId = parseInt(targetItem.dataset.todoId);
                const todoList = document.getElementById('todoList');
                const allItems = Array.from(todoList.querySelectorAll('.todo-item'));
                
                // Find positions
                const draggedIndex = allItems.findIndex(item => parseInt(item.dataset.todoId) === draggedId);
                const targetIndex = allItems.findIndex(item => parseInt(item.dataset.todoId) === targetId);
                
                if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
                    // Reorder in DOM first
                    const draggedItem = allItems[draggedIndex];
                    if (draggedIndex < targetIndex) {
                        targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
                    } else {
                        targetItem.parentNode.insertBefore(draggedItem, targetItem);
                    }
                    
                    // Get the new order after DOM manipulation
                    const newOrderedItems = Array.from(todoList.querySelectorAll('.todo-item'));
                    const newOrder = newOrderedItems.map(item => parseInt(item.dataset.todoId));
                    
                    // Update server with new order
                    reorderTodos(newOrder);
                    
                    // Update local todos array to match new order
                    const reorderedTodos = [];
                    newOrder.forEach(id => {
                        const todo = todos.find(t => t.id === id);
                        if (todo) {
                            reorderedTodos.push(todo);
                        }
                    });
                    todos = reorderedTodos;
                }
            }
            
            // Clean up
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }

        function sanitizeAndRenderHTML(htmlString) {
            if (!htmlString || htmlString.trim() === '') return 'No notes';
            // Basic HTML rendering - in production, you'd want to use a proper sanitizer
            return htmlString;
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            if (todos.length === 0) {
                todoList.innerHTML = '<div class="empty-state">No todos yet. Add one above!</div>';
                return;
            }

            // Create todos with proper HTML rendering
            todoList.innerHTML = '';
            todos.forEach(todo => {
                const todoDiv = document.createElement('div');
                todoDiv.className = 'todo-item';
                todoDiv.setAttribute('data-todo-id', todo.id);
                todoDiv.setAttribute('draggable', 'true');
                todoDiv.addEventListener('dragstart', handleDragStart);
                todoDiv.addEventListener('dragend', handleDragEnd);
                todoDiv.addEventListener('dragover', handleDragOver);
                todoDiv.addEventListener('dragenter', handleDragEnter);
                todoDiv.addEventListener('dragleave', handleDragLeave);
                todoDiv.addEventListener('drop', handleDrop);
                
                todoDiv.innerHTML = `
                    <div class="drag-handle">⋮⋮</div>
                    <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" 
                         onclick="toggleTodo(${todo.id}, ${!todo.completed})">
                        ${todo.completed ? '✓' : ''}
                    </div>
                    <div class="todo-content">
                        <div class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</div>
                        <div class="todo-timestamps">
                            Created: ${formatTimestamp(todo.created_at)}
                            ${todo.updated_at && todo.updated_at !== todo.created_at ? `| Updated: ${formatTimestamp(todo.updated_at)}` : ''}
                            ${todo.completed_at ? `| Completed: ${formatTimestamp(todo.completed_at)}` : ''}
                        </div>
                        <div class="notes-section" style="display: ${todo.notes && todo.notes.trim() ? 'block' : 'none'}">
                            <div class="notes-text"></div>
                            <div class="notes-buttons">
                                <button class="notes-btn" onclick="editNotes(${todo.id})">EDIT NOTES</button>
                            </div>
                        </div>
                    </div>
                    <div class="todo-actions">
                        <button class="edit-btn" onclick="startEdit(${todo.id})">EDIT</button>
                        <button class="notes-btn" onclick="toggleNotes(${todo.id})">NOTES</button>
                        <button class="delete-btn" onclick="deleteTodo(${todo.id})">DEL</button>
                    </div>
                `;
                
                // Set notes HTML content separately to allow HTML rendering
                const notesTextDiv = todoDiv.querySelector('.notes-text');
                notesTextDiv.innerHTML = sanitizeAndRenderHTML(todo.notes);
                
                todoList.appendChild(todoDiv);
            });
        }

        document.getElementById('todoInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            const dateString = now.toLocaleDateString('en-US');
            document.getElementById('timeDisplay').textContent = `${dateString} ${timeString}`;
        }

        setInterval(updateTime, 1000);
        updateTime();
        loadProject();
        loadTodos();
        
        // Auto-refresh todos every 30 seconds
        setInterval(loadTodos, 30000);
    </script>
</body>
</html>